const a6_0x4a5b=['Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','readFileSync','strip-json-comments','unlinkSync','then','../../api/error-reporter.api','executeTasks','includes','message','Critical\x20Error\x20in\x20Agent:\x20\x22','tasksRunnerOptions','existsSync','getBranch','FileStorage','./execute-tasks','printRunGroupError','__esModule','completeRunGroupWithError','random','note','yargs-parser','CIRCLECI','getNxCacheDirectory','DteArtifactStorage','DistributedAgentApi','getCIExecutionEnv','toString','CIRCLE_STAGE','NX_AGENT_NAME','../../file-storage/e2e-encryption','.lock','startAgent','done','next','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','some','/lockfiles','../../../utilities/environment','map','@nrwl/nx-cloud','If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.','warn','error','SIGTERM','encryptionKey','runner','catch','./invoke-tasks-using-run-many','CIRCLE_JOB','options','invokeTasksUsingRunMany','length','floor','dte-agent','invokeTasksUsingNxImperativeApi','mkdirSync','ErrorReporterApi','./distributed-agent.api','targets','defineProperty','Agent\x20was\x20terminated\x20via\x20SIGTERM','exit','canDetectRunGroup','parse','trim','/nx.json','Other\x20Nx\x20Cloud\x20Agents\x20Detected','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20target(s)\x20[','__awaiter','env','submitRunMetrics','./invoke-tasks-using-nx-imperative-api','default','We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','join','../../file-storage/file-storage','../../../utilities/dte-artifact-storage','value','Agent\x20was\x20terminated\x20via\x20SIGINT','throw'];(function(_0x3025cf,_0x4a5b3a){const _0x18b772=function(_0x2cec03){while(--_0x2cec03){_0x3025cf['push'](_0x3025cf['shift']());}};_0x18b772(++_0x4a5b3a);}(a6_0x4a5b,0x12e));const a6_0x18b7=function(_0x3025cf,_0x4a5b3a){_0x3025cf=_0x3025cf-0x0;let _0x18b772=a6_0x4a5b[_0x3025cf];return _0x18b772;};'use strict';var __awaiter=this&&this[a6_0x18b7('0x6')]||function(_0x527e4e,_0x341e9e,_0x15cac3,_0x588dd8){function _0x13c446(_0x26e4bc){return _0x26e4bc instanceof _0x15cac3?_0x26e4bc:new _0x15cac3(function(_0x207831){_0x207831(_0x26e4bc);});}return new(_0x15cac3||(_0x15cac3=Promise))(function(_0x3e27f9,_0x2b5da9){function _0x3a0c20(_0x152148){try{_0x474920(_0x588dd8[a6_0x18b7('0x33')](_0x152148));}catch(_0x34c3ae){_0x2b5da9(_0x34c3ae);}}function _0x112a02(_0x37a118){try{_0x474920(_0x588dd8[a6_0x18b7('0x11')](_0x37a118));}catch(_0x219652){_0x2b5da9(_0x219652);}}function _0x474920(_0x15a1ea){_0x15a1ea[a6_0x18b7('0x32')]?_0x3e27f9(_0x15a1ea[a6_0x18b7('0xf')]):_0x13c446(_0x15a1ea[a6_0x18b7('0xf')])[a6_0x18b7('0x16')](_0x3a0c20,_0x112a02);}_0x474920((_0x588dd8=_0x588dd8['apply'](_0x527e4e,_0x341e9e||[]))[a6_0x18b7('0x33')]());});};Object[a6_0x18b7('0x4d')](exports,a6_0x18b7('0x22'),{'value':!![]});exports[a6_0x18b7('0x31')]=void 0x0;const fs_1=require('fs');const stripJsonComments=require(a6_0x18b7('0x14'));const yargsParser=require(a6_0x18b7('0x26'));const environment_1=require(a6_0x18b7('0x37'));const metric_logger_1=require('../../../utilities/metric-logger');const print_cacheable_targets_error_1=require('../../error/print-cacheable-targets-error');const print_invalid_runner_error_1=require('../../error/print-invalid-runner-error');const print_run_group_error_1=require('../../error/print-run-group-error');const distributed_agent_api_1=require(a6_0x18b7('0x4b'));const execute_tasks_1=require(a6_0x18b7('0x20'));const dte_artifact_storage_1=require(a6_0x18b7('0xe'));const file_storage_1=require(a6_0x18b7('0xd'));const e2e_encryption_1=require(a6_0x18b7('0x2f'));const error_reporter_api_1=require(a6_0x18b7('0x17'));const invoke_tasks_using_run_many_1=require(a6_0x18b7('0x41'));const invoke_tasks_using_nx_imperative_api_1=require(a6_0x18b7('0x9'));const {output,initTasksRunner,workspaceRoot}=require('../../../utilities/nx-imports');const args=yargsParser(process['argv'],{'array':[a6_0x18b7('0x4c')],'default':{}});if(args[a6_0x18b7('0x4c')]&&args[a6_0x18b7('0x4c')]['length']===0x1){args[a6_0x18b7('0x4c')]=args[a6_0x18b7('0x4c')][0x0]['split'](',')[a6_0x18b7('0x38')](_0x454502=>_0x454502[a6_0x18b7('0x2')]());}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x2692c7=(0x0,environment_1[a6_0x18b7('0x1e')])();const _0x291271=(0x0,environment_1['getRunGroup'])();const _0x1b2b1a=(0x0,environment_1['getCIExecutionId'])();const _0x27d40b=(0x0,environment_1[a6_0x18b7('0x2b')])();if(!(0x0,print_run_group_error_1[a6_0x18b7('0x0')])(_0x291271,_0x1b2b1a)){(0x0,print_run_group_error_1[a6_0x18b7('0x21')])();process[a6_0x18b7('0x4f')](0x1);}if(args['targets']&&args['targets'][a6_0x18b7('0x45')]){output[a6_0x18b7('0x25')]({'title':a6_0x18b7('0x5')+args[a6_0x18b7('0x4c')][a6_0x18b7('0xc')](',\x20')+']'});}else{output['note']({'title':a6_0x18b7('0x12')});}const _0x4a986e=JSON[a6_0x18b7('0x1')](stripJsonComments((0x0,fs_1[a6_0x18b7('0x13')])(workspaceRoot+a6_0x18b7('0x3'))[a6_0x18b7('0x2c')]()))[a6_0x18b7('0x1c')][a6_0x18b7('0xa')];if(_0x4a986e[a6_0x18b7('0x3f')]!==a6_0x18b7('0x39')){(0x0,print_invalid_runner_error_1['printInvalidRunnerError'])();return process[a6_0x18b7('0x4f')](0x1);}const _0xb124c3=_0x4a986e[a6_0x18b7('0x43')];if(args[a6_0x18b7('0x4c')]&&args[a6_0x18b7('0x4c')][a6_0x18b7('0x35')](_0x1dfed0=>{var _0x117980;return!((_0x117980=_0xb124c3['cacheableOperations'])===null||_0x117980===void 0x0?void 0x0:_0x117980['includes'](_0x1dfed0));})){const _0x5084cf=args[a6_0x18b7('0x4c')]['filter'](_0x3bc139=>{var _0x3889ed;return!((_0x3889ed=_0xb124c3['cacheableOperations'])===null||_0x3889ed===void 0x0?void 0x0:_0x3889ed[a6_0x18b7('0x19')](_0x3bc139));});(0x0,print_cacheable_targets_error_1['printCacheableTargetsError'])(_0x5084cf);return process[a6_0x18b7('0x4f')](0x1);}const _0x1f9375=getAgentName();const _0xb237ef=new distributed_agent_api_1[(a6_0x18b7('0x2a'))](_0xb124c3,_0x2692c7,_0x291271,_0x1b2b1a,_0x27d40b,_0x1f9375);createAgentLockfileAndSetUpListeners(_0xb237ef,_0xb124c3,_0x1f9375);const _0x412235=new e2e_encryption_1['E2EEncryption'](environment_1['ENCRYPTION_KEY']||_0xb124c3[a6_0x18b7('0x3e')]);const _0x58eb3e=new error_reporter_api_1[(a6_0x18b7('0x4a'))](_0xb124c3);const _0xeb5e5=new dte_artifact_storage_1[(a6_0x18b7('0x29'))](new file_storage_1[(a6_0x18b7('0x1f'))](_0x412235,_0x58eb3e,_0xb124c3,a6_0x18b7('0x47')),(0x0,environment_1[a6_0x18b7('0x28')])(_0xb124c3));const _0x1b2d05=initTasksRunner?yield(0x0,invoke_tasks_using_nx_imperative_api_1[a6_0x18b7('0x48')])(_0xb124c3):yield(0x0,invoke_tasks_using_run_many_1[a6_0x18b7('0x44')])(_0xb124c3);return(0x0,execute_tasks_1[a6_0x18b7('0x18')])(_0x1f9375,_0xb237ef,_0xeb5e5,_0x1b2d05,args[a6_0x18b7('0x4c')])[a6_0x18b7('0x16')](_0x3b8058=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a6_0x18b7('0x8')])(_0xb124c3);return _0x3b8058;}))[a6_0x18b7('0x40')](_0x2ce9f4=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0xb237ef['completeRunGroupWithError'](a6_0x18b7('0x1b')+_0x2ce9f4[a6_0x18b7('0x1a')]+'\x22');throw _0x2ce9f4;}));});}exports['startAgent']=startAgent;function getAgentName(){if(process[a6_0x18b7('0x7')][a6_0x18b7('0x2e')]!==undefined){return process[a6_0x18b7('0x7')][a6_0x18b7('0x2e')];}else if(process[a6_0x18b7('0x7')][a6_0x18b7('0x27')]!==undefined&&process[a6_0x18b7('0x7')][a6_0x18b7('0x2d')]){return process[a6_0x18b7('0x7')][a6_0x18b7('0x2d')];}else if(process['env']['CIRCLECI']!==undefined&&process[a6_0x18b7('0x7')]['CIRCLE_JOB']){return process['env'][a6_0x18b7('0x42')];}else{return'Agent\x20'+Math[a6_0x18b7('0x46')](Math[a6_0x18b7('0x24')]()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x567cf3,_0x3d3be4,_0x13ab00){const _0x13b436=(0x0,environment_1['getNxCacheDirectory'])(_0x3d3be4);const _0x458ab1=_0x13b436+a6_0x18b7('0x36');const _0x2a9cae=_0x458ab1+'/'+_0x13ab00+'.lock';if(!(0x0,fs_1['existsSync'])(_0x458ab1)){(0x0,fs_1[a6_0x18b7('0x49')])(_0x458ab1,{'recursive':!![]});}const _0x2f0955=(0x0,fs_1['readdirSync'])(_0x458ab1);if(_0x2f0955[a6_0x18b7('0x45')]){if(_0x2f0955[a6_0x18b7('0x19')](_0x13ab00+a6_0x18b7('0x30'))){output[a6_0x18b7('0x3c')]({'title':'Duplicate\x20Agent\x20ID\x20Detected','bodyLines':['We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.']});process[a6_0x18b7('0x4f')](0x1);}output[a6_0x18b7('0x3b')]({'title':a6_0x18b7('0x4'),'bodyLines':[a6_0x18b7('0xb'),'',a6_0x18b7('0x34'),a6_0x18b7('0x3a')]});}(0x0,fs_1['writeFileSync'])(_0x2a9cae,'');process['on'](a6_0x18b7('0x4f'),_0x1b388d=>{cleanupAgentLockfile(_0x2a9cae,_0x1b388d);});process['on'](a6_0x18b7('0x3d'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x567cf3[a6_0x18b7('0x23')](a6_0x18b7('0x4e'));cleanupAgentLockfile(_0x2a9cae,0x1);}));process['on']('SIGINT',()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x567cf3[a6_0x18b7('0x23')](a6_0x18b7('0x10'));cleanupAgentLockfile(_0x2a9cae,0x1);}));}function cleanupAgentLockfile(_0x57c094,_0x2a92b3){if((0x0,fs_1[a6_0x18b7('0x1d')])(_0x57c094)){(0x0,fs_1[a6_0x18b7('0x15')])(_0x57c094);process[a6_0x18b7('0x4f')](_0x2a92b3);}}